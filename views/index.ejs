<!DOCTYPE html>
<html>
<head>
    <title>VibeStream Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ESTILOS */
        * { box-sizing: border-box; }
        body { background-color: #000; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; font-family: 'Montserrat', sans-serif; }
        .sidebar { width: 250px; background: #000; padding: 25px; display: flex; flex-direction: column; border-right: 1px solid #1a1a1a; flex-shrink: 0; }
        .logo { font-size: 26px; font-weight: 800; margin-bottom: 40px; color: #fff; display:flex; align-items:center; gap:10px;}
        .logo span { color: #1db954; font-size:30px;}
        .menu-item { text-decoration: none; color: #b3b3b3; font-weight: 600; font-size: 14px; padding: 12px 0; display: flex; align-items: center; gap: 15px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { color: #fff; }
        .menu-item.active { border-right: 3px solid #1db954; }
        .main { flex: 1; padding: 30px 50px; overflow-y: auto; position: relative; background: linear-gradient(180deg, #202020 0%, #121212 40%); padding-bottom: 120px; }
        h1, h2 { letter-spacing: -0.5px; }
        h2 { font-size: 22px; margin-top: 30px; margin-bottom: 20px; }
        .card-grid { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; }
        .card { background: #181818; padding: 15px; border-radius: 8px; width: 180px; flex-shrink: 0; transition: background 0.3s; cursor: pointer; }
        .card:hover { background: #282828; }
        .card-img { width: 100%; aspect-ratio: 1; border-radius: 6px; margin-bottom: 12px; background-size: cover; background-position: center; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .card-title { font-weight: 700; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-bottom: 5px;}
        .card-sub { font-size: 13px; color: #b3b3b3; display: block; margin-bottom: 10px;}
        .track-row { display: flex; align-items: center; padding: 10px 15px; border-radius: 6px; transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .track-row:hover { background: rgba(255,255,255,0.1); }
        .t-cover { width: 45px; height: 45px; border-radius: 4px; margin-right: 15px; background-size: cover; background-position: center; flex-shrink: 0; }
        .col-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .col-album { width: 25%; color: #aaa; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .col-meta { width: 20%; color: #aaa; font-size: 13px; }
        .col-dur { width: 10%; color: #aaa; font-size: 13px; text-align: right; margin-right: 20px;}
        .btn-fav { background: transparent; border: 1px solid #666; color: #fff; border-radius: 20px; height: 32px; padding: 0 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 12px; font-weight: bold; }
        .btn-fav:hover { border-color: #fff; transform: scale(1.05); }
        .btn-fav.saved { background: #1db954; border-color: #1db954; color: #000; }
        .btn-fav.saved:hover { background: #1ed760; }
        .btn-fav.remove { background: transparent; border-color: #ff5555; color: #ff5555; }
        .btn-fav.remove:hover { background: #ff5555; color: white; }
        .player-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 90px; background: #181818; border-top: 1px solid #282828; z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .progress-bar { width: 100%; height: 4px; background: #555; border-radius: 2px; }
        .progress-fill { width: 30%; height: 100%; background: #fff; border-radius: 2px; }
        .search-input { width: 100%; padding: 15px 25px; border-radius: 50px; border: none; font-size: 16px; margin-bottom: 30px; outline: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><span>‚ö°</span> VibeStream</div>
        <a href="/" class="menu-item <%= page=='home'?'active':'' %>">üè† In√≠cio</a>
        <a href="/search" class="menu-item <%= page=='search'?'active':'' %>">üîç Buscar</a>
        <a href="/library" class="menu-item <%= page=='library'?'active':'' %>">üìö Biblioteca</a>
        <a href="/profile" class="menu-item <%= page=='profile'?'active':'' %>">‚öôÔ∏è Perfil</a>
        <div style="margin-top: auto; border-top: 1px solid #333; padding-top: 20px;">
            <div style="font-size: 13px; color: #999;">Logado como</div>
            <div style="font-weight: bold; margin-bottom: 10px;"><%= usuario.nome %></div>
            <a href="/logout" style="color:#b3b3b3; text-decoration:none; font-size: 12px;">Sair da conta</a>
        </div>
    </div>

    <div class="main">

        <% if (page == 'home') { %>

            <% if (typeof recomendacoes !== 'undefined' && recomendacoes.length > 0) { %>
                <h2>Tocadas para voc√™ (Mix de Gosto + Favoritos)</h2>
                <div class="card-grid">
                    <% recomendacoes.forEach(m => { %>
                        <div class="card">
                            <div class="card-img" style="background-image: url('<%= m.capa %>');"></div>
                            <span class="card-title"><%= m.titulo %></span>
                            <span class="card-sub"><%= m.artista ? m.artista.nome : '...' %></span>
                            <form action="/favoritar/<%= m._id %>" method="POST" style="margin-top:10px;">
                                <button class="btn-fav" title="Adicionar">Ôºã Add</button>
                            </form>
                        </div>
                    <% }) %>
                </div>
            <% } %>

            <h2>Cat√°logo Completo</h2>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <% musicas.forEach((m, i) => { %>
                    <div class="track-row">
                        <span style="width: 30px; color: #777; font-size: 14px;"><%= i + 1 %></span>
                        <div class="t-cover" style="background-image: url('<%= m.capa %>');"></div>

                        <div class="col-info">
                            <div style="font-weight: 600; font-size: 15px;"><%= m.titulo %></div>

                            <div style="display: flex; align-items: center; gap: 5px;">
                                <small style="color: #b3b3b3; font-size: 13px;">
                                    <%= m.artista ? m.artista.nome : '...' %>
                                </small>
                                <% if (m.artista) { %>
                                    <form action="/favoritar-artista/<%= m.artista._id %>?return=/" method="POST" style="display:inline;">
                                        <% if (typeof idsArtistasFavoritos !== 'undefined' && idsArtistasFavoritos.includes(m.artista._id.toString())) { %>
                                            <button style="background:none; border:none; cursor:pointer; color:#1db954; font-size:14px; padding:0;" title="Deixar de Seguir">‚òÖ</button>
                                        <% } else { %>
                                            <button style="background:none; border:none; cursor:pointer; color:#555; font-size:14px; padding:0;" title="Seguir Artista">‚òÜ</button>
                                        <% } %>
                                    </form>
                                <% } %>
                            </div>

                        </div>

                        <div class="col-album"><%= m.album %></div>
                        <div class="col-meta"><%= m.genero %> ‚Ä¢ <%= m.ano %></div>
                        <div class="col-dur"><%= m.duracao %></div>

                        <form action="/favoritar/<%= m._id %>" method="POST">
                            <% if (typeof idsFavoritos !== 'undefined' && idsFavoritos.includes(m._id.toString())) { %>
                                <button class="btn-fav saved">‚úî Salvo</button>
                            <% } else { %>
                                <button class="btn-fav">Add</button>
                            <% } %>
                        </form>
                    </div>
                <% }) %>
            </div>
        <% } %>


        <% if (page == 'library') { %>
            <div style="display:flex; align-items:center; gap:20px; margin-bottom:30px;">
                <div style="width:180px; height:180px; background: linear-gradient(135deg, #450af5, #c4efd9); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; font-size:50px;">üíú</div>
                <div>
                    <span style="font-size:12px; font-weight:bold;">PLAYLIST</span>
                    <h1 style="font-size:60px; margin:10px 0;">M√∫sicas Curtidas</h1>
                    <p><%= usuario.nome %> ‚Ä¢ <%= minhasMusicas.length %> m√∫sicas salvas</p>
                </div>
            </div>

            <% if (minhasMusicas.length == 0) { %> <p style="color:#777; margin-top:50px;">Sua biblioteca est√° vazia.</p> <% } %>

            <% minhasMusicas.forEach(m => { %>
                <div class="track-row">
                    <div class="t-cover" style="background-image: url('<%= m.capa %>');"></div>
                    <div class="col-info">
                        <strong style="font-size:16px;"><%= m.titulo %></strong>
                        <small style="color:#999"><%= m.artista ? m.artista.nome : '' %></small>
                    </div>
                    <div class="col-album"><%= m.album %></div>
                    <div class="col-meta"><%= m.ano %></div>
                    <div class="col-dur"><%= m.duracao %></div>
                    <form action="/favoritar/<%= m._id %>?return=/library" method="POST">
                        <button class="btn-fav remove" title="Remover">‚úñ Remover</button>
                    </form>
                </div>
            <% }) %>
        <% } %>

        <% if (page == 'search') { %>
            <h1>Buscar</h1>
            <form action="/search" method="GET">
                <input type="text" name="q" class="search-input" placeholder="Buscar Artista ou M√∫sica..." value="<%= locals.query || '' %>" autofocus>
            </form>

            <% if (locals.resultados) { %>
                <% if (resultados.length > 0) { %>
                    <h2>Resultados</h2>
                    <% resultados.forEach(m => { %>
                        <div class="track-row">
                            <div class="t-cover" style="background-image: url('<%= m.capa %>');"></div>

                            <div class="col-info">
                                <strong><%= m.titulo %></strong>

                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <small style="color:#999">
                                        <%= m.artista ? m.artista.nome : '' %>
                                    </small>
                                    <% if (m.artista) { %>
                                        <form action="/favoritar-artista/<%= m.artista._id %>?return=/search?q=<%= query %>" method="POST" style="display:inline;">
                                            <% if (typeof idsArtistasFavoritos !== 'undefined' && idsArtistasFavoritos.includes(m.artista._id.toString())) { %>
                                                <button style="background:none; border:none; cursor:pointer; color:#1db954; font-size:14px; padding:0;" title="Deixar de Seguir">‚òÖ</button>
                                            <% } else { %>
                                                <button style="background:none; border:none; cursor:pointer; color:#555; font-size:14px; padding:0;" title="Seguir Artista">‚òÜ</button>
                                            <% } %>
                                        </form>
                                    <% } %>
                                </div>
                            </div>

                            <div class="col-album"><%= m.album %></div>

                            <form action="/favoritar/<%= m._id %>?return=/search?q=<%= query %>" method="POST">
                                <% if (typeof idsFavoritos !== 'undefined' && idsFavoritos.includes(m._id.toString())) { %>
                                    <button class="btn-fav saved">‚úî</button>
                                <% } else { %>
                                    <button class="btn-fav">Add</button>
                                <% } %>
                            </form>
                        </div>
                    <% }) %>
                <% } else { %>
                    <p>Nenhum resultado encontrado.</p>
                <% } %>
            <% } else { %>
                <h3>Navegar por G√™nero</h3>
                <div style="display:flex; flex-wrap:wrap; gap:20px;">
                    <div style="background:#e91e63; width:200px; height:120px; border-radius:10px; padding:20px; font-weight:bold; font-size:24px;">Rock</div>
                    <div style="background:#ff9800; width:200px; height:120px; border-radius:10px; padding:20px; font-weight:bold; font-size:24px;">Sertanejo</div>
                    <div style="background:#2196f3; width:200px; height:120px; border-radius:10px; padding:20px; font-weight:bold; font-size:24px;">Pop</div>
                    <div style="background:#9c27b0; width:200px; height:120px; border-radius:10px; padding:20px; font-weight:bold; font-size:24px;">Hip Hop</div>
                </div>
            <% } %>
        <% } %>

        <% if (page == 'profile') { %>
            <h1>Editar Perfil</h1>
            <div style="background:#181818; padding:40px; border-radius:10px; max-width:600px;">
                <h3>Prefer√™ncias Musicais</h3>
                <form action="/update-genres" method="POST">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <% ['Rock', 'Sertanejo', 'Pop', 'HipHop', 'Eletronica', 'Indie'].forEach(g => { %>
                            <label style="background: #252525; padding: 20px; border-radius: 8px; cursor: pointer; text-align: center; border: 2px solid transparent; transition:0.2s;">
                                <input type="checkbox" name="generos" value="<%= g %>"
                                    <%= usuario.generosPreferidos.includes(g) ? 'checked' : '' %>
                                    style="display:none;" onchange="this.parentNode.style.borderColor = this.checked ? '#1db954' : 'transparent'; this.parentNode.style.color = this.checked ? '#1db954' : '#fff';">
                                <%= g %>
                            </label>
                            <script>
                                document.querySelectorAll('input[value="<%= g %>"]').forEach(el => {
                                    if(el.checked) { el.parentNode.style.borderColor = '#1db954'; el.parentNode.style.color = '#1db954'; }
                                });
                            </script>
                        <% }) %>
                    </div>
                    <br><button style="background:#fff; color:#000; border:none; padding:15px 40px; font-weight:bold; border-radius:30px; cursor:pointer; font-size:14px; margin-top:20px;">Salvar Altera√ß√µes</button>
                </form>
            </div>
        <% } %>

    </div>

    <div class="player-bar">
        <div style="display:flex; align-items:center; gap:15px; width:30%;">
            <%
                let tocando = { titulo: "VibeStream", artista: {nome: "Bem-vindo"}, capa: "https://via.placeholder.com/50", duracao: "--:--" };
                if (typeof recomendacoes !== 'undefined' && recomendacoes.length > 0) { tocando = recomendacoes[0]; }
            %>
            <div style="width: 55px; height: 55px; background-image: url('<%= tocando.capa %>'); background-size: cover; border-radius: 4px;"></div>
            <div>
                <div style="font-weight: bold; font-size: 14px;"><%= tocando.titulo %></div>
                <div style="font-size: 11px; color: #b3b3b3;"><%= tocando.artista ? tocando.artista.nome : '' %></div>
            </div>
            <span style="color: #1db954; font-size:20px; margin-left:10px;">‚ô•</span>
        </div>

        <div style="display:flex; flex-direction:column; align-items:center; width:40%; gap:8px;">
            <div style="font-size: 20px; display: flex; gap: 25px; color: #b3b3b3; align-items:center;">
                <span>üîÄ</span> <span>‚èÆ</span> <span style="font-size: 35px; color: #fff;">‚ñ∂</span> <span>‚è≠</span> <span>üîÅ</span>
            </div>
            <div style="width: 100%; display: flex; align-items: center; gap: 10px; font-size: 11px; color: #777;">
                0:45 <div class="progress-bar"><div class="progress-fill"></div></div> <%= tocando.duracao || "--:--" %>
            </div>
        </div>

        <div style="width: 30%; display:flex; justify-content:flex-end; color:#b3b3b3;">üîä ‚îÅ‚îÅ‚óè</div>
    </div>

</body>
</html>
